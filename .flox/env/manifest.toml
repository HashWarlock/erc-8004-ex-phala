## Flox Environment Manifest for ERC-8004 Phala Cloud Project --------
version = 1

## Install Packages --------------------------------------------------
[install]
python3.pkg-path = "python3"
nodejs.pkg-path = "nodejs"
git.pkg-path = "git"
curl.pkg-path = "curl"
foundry.pkg-path = "foundry"
jq.pkg-path = "jq"
rustup.pkg-path = "rustup"

## Environment Variables ---------------------------------------------
[vars]
PROJECT_NAME = "erc-8004-ex-phala"
PYTHON_VERSION = "3.11"
NODE_ENV = "development"
TEE_SIMULATOR_PORT = "8090"
TEE_SIMULATOR_HOST = "localhost"
TEE_MODE = "simulator"

## Activation Hook ---------------------------------------------------
[hook]
on-activate = '''
  echo "🚀 Activating ERC-8004 Phala Cloud development environment..."
  
  # Setup Python virtual environment
  export PYTHON_DIR="$FLOX_ENV_CACHE/python"
  if [ ! -d "$PYTHON_DIR" ]; then
    echo "📦 Creating Python virtual environment..."
    python3 -m venv "$PYTHON_DIR"
  fi
  
  # Activate venv and install packages in a subshell
  (
    source "$PYTHON_DIR/bin/activate"
    
    # Install base requirements
    if [ -f "$FLOX_ENV_PROJECT/requirements.txt" ]; then
      echo "📚 Installing Python dependencies..."
      pip install --upgrade pip setuptools wheel --quiet
      pip install -r "$FLOX_ENV_PROJECT/requirements.txt" --quiet
    fi
    
    # Install dstack SDK
    echo "🔐 Installing dstack SDK for TEE support..."
    pip install dstack-sdk --quiet 2>/dev/null || true
    
    # Install additional packages
    pip install web3 crewai python-dotenv --quiet 2>/dev/null || true
  )
  
  echo "✅ Environment ready!"
'''

## Profile script ----------------------------------------------------
[profile]
bash = '''
  # Python virtual environment
  export PYTHON_DIR="$FLOX_ENV_CACHE/python"
  export VIRTUAL_ENV="$PYTHON_DIR"
  export PATH="$PYTHON_DIR/bin:$PATH"
  source "$PYTHON_DIR/bin/activate"
  
  # TEE Simulator configuration for development
  # Use dstack.sock for dstack OS 0.5.x (current), tappd.sock for 0.3.x (deprecated)
  export DSTACK_SIMULATOR_ENDPOINT="$FLOX_ENV_PROJECT/.dstack/sdk/simulator/dstack.sock"
  
  # Check if TEE simulator is running
  if [ -S "$DSTACK_SIMULATOR_ENDPOINT" ]; then
    echo "🔐 TEE Simulator: Active (socket: dstack.sock)"
  else
    echo "⚠️  TEE Simulator: Not running (run: make tee-start)"
  fi
  
  # Display project info
  echo "━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━"
  echo "  ERC-8004 Trustless Agents - Phala Cloud Edition"
  echo "━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━"
  echo ""
'''

zsh = '''
  # Python virtual environment
  export PYTHON_DIR="$FLOX_ENV_CACHE/python"
  export VIRTUAL_ENV="$PYTHON_DIR"
  export PATH="$PYTHON_DIR/bin:$PATH"
  source "$PYTHON_DIR/bin/activate"
  
  # TEE Simulator configuration for development
  # Use dstack.sock for dstack OS 0.5.x (current), tappd.sock for 0.3.x (deprecated)
  export DSTACK_SIMULATOR_ENDPOINT="$FLOX_ENV_PROJECT/.dstack/sdk/simulator/dstack.sock"
  
  # Check if TEE simulator is running
  if [ -S "$DSTACK_SIMULATOR_ENDPOINT" ]; then
    echo "🔐 TEE Simulator: Active (socket: dstack.sock)"
  else
    echo "⚠️  TEE Simulator: Not running (run: make tee-start)"
  fi
  
  # Display project info
  echo "━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━"
  echo "  ERC-8004 Trustless Agents - Phala Cloud Edition"
  echo "━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━"
  echo ""
'''

## Services ----------------------------------------------------------
[services]

## Other Environment Options -----------------------------------------
[options]
systems = [
  "aarch64-darwin",
  "aarch64-linux",
  "x86_64-darwin",
  "x86_64-linux"
]